<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../iron-ajax/iron-ajax.html" />
<dom-module id="krypton-list">
    <!--
    `<krypton-list>` provides simple methods to fetch a list of entities. Make sure that baseUrl is set on the window
        context before using this element.
    Example:
        <script>
            window.baseUrl = "http://mydevsite.blah.com";
        </script>
        <krypton-list path="/api/cars/byOwner?ownerId={{ownerId}}"></krypton-list>
    @group krypton Elements
    @element krypton-list
    -->
    <template>
        <iron-ajax id="ajax"
                   handle-as="json"
                   on-response="_onResponse"
                   content-type="application/json"
                   loading="{{loading}}">
        </iron-ajax>
    </template>
    <script>
        Polymer({
            is: "krypton-list",
            properties: {
                /* Output property, the list of entitys from your c# */
                items: { type: Array, notify: true },
                /* Base part of the url. Usually set on window context. */
                baseUrl: { type: String },
                /* Url path appended to the baseUrl */
                path: { type: String, observer: "_pathChange" },
                /* false, true if data is being fetched from server */
                loading: { type: Boolean, notify: true, value: false },
                /* paging info for items*/
                pageInfo: { type: Object, notify: true },
                currentPage: { type: Number, value: 1 }

            },
            observers: [
                "_onPageInfoPageChanged(pageInfo.page)"
            ],
            ready: function () {
                // if baseUrl is available on the window context, grab it
                if (this.baseUrl == undefined && window.baseUrl != undefined) {
                    this.baseUrl = window.baseUrl;
                }
            },
            // call this to force a fetch of items
            generateRequest: function() {
                var base = (this.baseUrl == undefined) ? "" : this.baseUrl;
                this.$.ajax.url = base + this.path;
                this.$.ajax.generateRequest();
            },
            // check to make sure all bindings in the path are resolved, then generateRequest
            _pathChange: function (path) {
                if (path == undefined || path.indexOf("=&") != -1 || path.charAt(path.length - 1) == "=") return;
                this.generateRequest();
            },
            // Sets the items property to the e.detail of the response.
            _onResponse: function (e, request) {
                var response = e.detail.response;
                this.__resolvePageInfoHeaders(request);
                this.set("items", response);
                this.fire("krypton-list", this.items);
            },
            _onPageInfoPageChanged: function (page) {
                if (page == this.currentPage) return;
                var segments = this.path.split("/");
                var path = segments[0].concat("/", segments[1].split("?")[0], "?page=" + page + "&total=" + this.pageInfo.total);
                this.set("path", path);
            },
            __resolvePageInfoHeaders: function (request) {
                var kryptonPage = request.xhr.getResponseHeader("krypton-page");
                var kryptonTotal = request.xhr.getResponseHeader("krypton-total");
                var kryptonPageSize = request.xhr.getResponseHeader("krypton-pageSize");

                if (kryptonPage === undefined || kryptonPage == null
                || kryptonTotal === undefined || kryptonTotal == null
                || kryptonPageSize === undefined || kryptonPageSize == null) return;
                this.set("currentPage", Number(kryptonPage));

                this.set("pageInfo", { page: Number(kryptonPage), total: Number(kryptonTotal), pageSize: Number(kryptonPageSize) });

            }
        });
    </script>
</dom-module>
